
import React, { useEffect, useState } from 'react';
import './EstimateForm.css';
import EstimateResult from "./EstimateResult";
import axios from 'axios';

const EstimateForm = () => {
    // state for generating estimate
    const [estimateReady, setEstimateReady] = useState(false);
  
    // material states
    const [materialType, setMaterialType] = useState('');
    const [materialName, setMaterialName] = useState('');
    const [unitPrice, setUnitPrice] = useState('');
    const [quantity, setQuantity] = useState('');
    const [unit, setUnit] = useState('');
    const [materialList, setMaterialList] = useState([]);
    const [materialOptions, setMaterialOptions] = useState([]);
   
    // labor states
    const [laborType, setLaborType] = useState('');
    const [laborRate, setLaborRate] = useState({
        apprentice: 30,
        regular: 60,
        projectManager: 80,
    });
    const [laborQuantity, setLaborQuantity] = useState();
    const [laborList, setLaborList] = useState([]);
    const [laborDescription, setLaborDescription] = useState('');

    // business expenses states
    const [materialMarkupPercentage, setMaterialMarkupPercentage] = useState(10);
    const [finalCostsPercentage, setFinalCostsPercentage] = useState(20);

    // customer information states
    const [customerName, setCustomerName] = useState('');
    const [customerAddress, setCustomerAddress] = useState('');
    const [customerCityStatePostalCode, setCustomerCityStatePostalCode] = useState('');
    const [customerPhone, setCustomerPhone] = useState('');
    const [customerEmail, setCustomerEmail] = useState('');

    // check to make sure all information is filled before generation
    const handleGenerateEstimate = () => {
      if (
        !customerName.trim() ||
        !customerAddress.trim() ||
        !customerCityStatePostalCode.trim() ||
        !customerPhone.trim() ||
        !customerEmail.trim()
      ) {
        alert("Please fill in all customer information before generating the estimate.");
        return;
      }
  
      if (materialList.length === 0 && laborList.length === 0) {
        alert("Please add at least one material or labor entry before generating the estimate.");
        return;
      }
  
      // Everything is valid
      setEstimateReady(true);
    };
    
    // input handlers for materials
    useEffect(() => {
      if (materialType !== '') {
        // fetch materials based on the selected material type
        axios
          .get(`http://localhost:3001/api/materials/${materialType}`)
          .then((response) => {
            console.log('Fetched Materials:', response.data); // Log response
            // set the material options data based on the type
            setMaterialOptions(response.data);
          })
          .catch((error) => {
            console.error('Error fetching materials:', error);
          });
      } else {
        setMaterialOptions([]);
      }
  
      // reset selections when material type changes
      setMaterialName('');
      setUnitPrice('');
      setUnit('');
    }, [materialType]);
  
    // material handlers
    const handleMaterialTypeChange = (e) => {
      setMaterialType(e.target.value);
    };
  
    const handleMaterialNameChange = (e) => {
      const selectedId = e.target.value;
      setMaterialName(selectedId);
  
      // find the selected material based on the ID
      const selectedMaterial = materialOptions.find((mat) => mat.id.toString() === selectedId);
      if (selectedMaterial) {
        setUnitPrice(selectedMaterial.unit_price);
        setUnit(selectedMaterial.unit);
      } else {
        setUnitPrice('');
        setUnit('');
      }
    };
    
    // handlers for unit and price
    const handleUnitPriceChange = (e) => {
      setUnitPrice(e.target.value);
    };

    const handleUnitChange = (e) => {
      setUnit(e.target.value);
    };
      const handleQuantityChange = (e) => {
      setQuantity(e.target.value);
    };

    // input handlers for labor
    const handleLaborTypeChange = (e) => setLaborType(e.target.value);
    const handleLaborRateChange = (e) => {

      const input = e.target.value;

    // allow user to clear the input while typing
    if (input === "") {
        setLaborRate((prevRates) => ({
            ...prevRates,
            [laborType]: "",
        }));
        return;
      }
        // only update rate if it's a valid number
        const value = parseFloat(e.target.value);
        if (value >= 0) {
            setLaborRate((prevRates) => ({
                ...prevRates,
                [laborType]: value,
            }));
        }
    };
    const handleLaborQuantityChange = (e) => setLaborQuantity(e.target.value);
    const handleLaborDescriptionChange = (e) => setLaborDescription(e.target.value);
 
     // input handlers for business expenses
    const handleMaterialMarkupChange = (e) => {
      const value = parseFloat(e.target.value);

      // validty checks for markup prevent negatives from being entered at all since update state comes after
      // check if the value is negative and show an alert,
      if (value < 0 || value > 200) {
          alert("Material markup percentage must be a non-negative value and less than 201.");
          return; // dont update state if the value is invalid
      }
      // since this is after validty check negative entries are not allowed to update the state
      setMaterialMarkupPercentage(value);
  };

  const handleFinalCostsChange = (e) => {
      const value = parseFloat(e.target.value);

      // check if the value is negative and show an alert
      if (value < 0 || value > 200) {
          alert("Final markup percentage must be a non-negative value and less than 201.");
          return; // dont update state if the value is invalid
      }
      // since this is after validty check negative entries are not allowed to update the state
      setFinalCostsPercentage(value);
    };

    // input handlers for customer information
    const handleCustomerNameChange = (e) => setCustomerName(e.target.value);
    const handleCustomerAddressChange = (e) => setCustomerAddress(e.target.value);
    const handleCustomerCityStatePostalCodeChange = (e) => setCustomerCityStatePostalCode(e.target.value);
    const handleCustomerPhoneChange = (e) => setCustomerPhone(e.target.value);
    const handleCustomerEmailChange = (e) => setCustomerEmail(e.target.value);

    // add material to list function
    const addMaterial = () => {
      const parsedPrice = parseFloat(unitPrice);
      const parsedQty = parseInt(quantity);
      
      // validity checks for materials
      if (
        !materialName ||  materialName.length > 100 
        ||isNaN(parsedPrice) || parsedPrice < 0 || parsedPrice >= 100000 ||
        isNaN(parsedQty) || parsedQty <= 0 || parsedQty >= 100000
      ){
        alert(`Please fill in all fields with valid values.
Material Name must be under 100 characters.
Price must be a non-negative value and less than 100,000.
Quantity must be a positive value and less than 100,000.`);
        return;
      }
      // create material objects
      const newMaterial = {
        type: materialType,
        name: materialName,
        price: parsedPrice,
        quantity: parsedQty,
        unit: unit,
        total: parsedPrice * parsedQty,
      };

      // apply material markup percentage
      newMaterial.markupTotal = newMaterial.total + (newMaterial.total * (materialMarkupPercentage / 100));

      // add material to list
      setMaterialList([...materialList, newMaterial]);
  
      // Reset form fields
      setMaterialName('');
      setUnitPrice('');
      setQuantity('');
      setUnit('Length');
    };

    // add labor to list function
    const addLabor = () => {
      const rateRaw = laborRate[laborType];
      const rate = parseFloat(rateRaw);
      const quantity = parseFloat(laborQuantity);

    // validty checks for labor, allow rate of 0
    if (!laborType || isNaN(rate) || rate < 0 || rate >= 1000) {
        alert(`Please select a labor type and provide a valid rate.
Rate must be a non-negative value and less than 1,000.`);
        return;
    }

    if (isNaN(quantity) || quantity <= 0 || quantity >= 10000) {
        alert(`Please provide a valid labor quantity.
Quantity must be a positive value and less than 10,000.`);
        return;
    }

    if (laborDescription && laborDescription.length > 100) {
      alert("Labor description must be 100 characters or fewer.");
      return;
    }
      const totalCost = rate * laborQuantity;

      const newLabor = {
          type: laborType,
          rate: rate,
          quantity: laborQuantity,
          total: totalCost,
          description: laborDescription,
      };
      // add labor to list
      setLaborList([...laborList, newLabor]);

      // reset labor form
      setLaborType('');
      setLaborQuantity('');
      setLaborDescription('');
    };
    
    // delete material function
    const deleteMaterial = (index) => {
      const newMaterialList = materialList.filter((_, i) => i !== index);
      setMaterialList(newMaterialList);
    };

    // delete labor function
    const deleteLabor = (index) => {
      const newLaborList = laborList.filter((_, i) => i !== index);
      setLaborList(newLaborList);
    };

    // calculate total estimate 
    const calculateTotalEstimate = () => {
      const totalMaterialsCost = materialList.reduce((acc, material) => acc + material.markupTotal, 0);
      const totalLaborCost = laborList.reduce((acc, labor) => acc + labor.total, 0);

      const subtotal = totalMaterialsCost + totalLaborCost;

      // apply final cost percentage to the subtotal
      const finalEstimate = subtotal + (subtotal * (finalCostsPercentage / 100));
      // returns total estimate rounded to 2 decimal places
      return Math.round(finalEstimate * 100) / 100; 
    };


    // return for displaying
    return (
      <div className="estimate-form">
        <h2>Estimate Form</h2>
        
        {/* customer info section */}
        <div className="customer-info-box">
            <h3>Customer Information</h3>

            <label>
                Customer Name:
                <input
                    type="text"
                    value={customerName}
                    onChange={handleCustomerNameChange}
                />
            </label>

            <label>
                Address:
                <input
                    type="text"
                    value={customerAddress}
                    onChange={handleCustomerAddressChange}
                />
            </label>

            <label>
                City, State, Postal Code:
                <input
                    type="text"
                    value={customerCityStatePostalCode}
                    onChange={handleCustomerCityStatePostalCodeChange}
                />
            </label>

            <label>
                Phone Number:
                <input
                    type="text"
                    value={customerPhone}
                    onChange={handleCustomerPhoneChange}
                />
            </label>

            <label>
                Email Address:
                <input
                    type="email"
                    value={customerEmail}
                    onChange={handleCustomerEmailChange}
                />
            </label>
        </div>

        {/* material section */}
        <div className="material-box">
          <h3>Materials</h3>
          {/* dropdown for material type */}
          {/* dropdown for material type */}
  <label>
    Material Type:
    <select value={materialType} onChange={handleMaterialTypeChange}>
      <option value="">Select Type</option>
      <option value="lumber">Lumber</option>
      <option value="finishing_materials">Finishing Materials</option>
      <option value="hardware">Hardware</option>
      <option value="misc_materials">Miscellaneous Materials</option>
      <option value="custom">Custom</option> {/* Option for custom materials */}
    </select>
  </label>

  {/* dropdown for material name */}
  {materialType && (
    <label>
      Material Name:
      <select value={materialName} onChange={handleMaterialNameChange}>
        <option value="">Select Material</option>
        {materialOptions.map((mat) => (
          <option key={mat.id} value={mat.id}>
            {mat.name}
          </option>
        ))}
      </select>
    </label>
  )}

  {/* unit price input (auto-filled when material name is selected) */}
  <label>
    Unit Price:
    <input
      type="number"
      value={unitPrice}
      onChange={handleUnitPriceChange}
      min="0"
      step="0.01"
      disabled
    />
  </label>

  {/* quantity input */}
  <label>
    Quantity:
    <input
      type="number"
      value={quantity}
      onChange={handleQuantityChange}
      min="1"
    />
  </label>

  {/* unit size input */}
  <label>
    Unit:
    <select value={unit} onChange={handleUnitChange}>
      <option value="Length">Length</option>
      <option value="SqFt">SqFt</option>
      <option value="LinearFt">LinearFt</option>
      <option value="CubicYard">CubicYard</option>
    </select>
  </label>
          
          {/* button for adding materials to list */}
          <button type="button" onClick={addMaterial}>Add Material</button>
        </div>
          
        {/* material list section */}
        {materialList.length > 0 && (
          <div className="material-list">
            <h3>Added Materials</h3>
            <ul>
              {materialList.map((mat, index) => (
                <li key={index}>
                  {mat.quantity} {mat.unit} of <strong>{mat.name}</strong> ({mat.type}) @ ${mat.price.toFixed(2)} each = <strong>${mat.total.toFixed(2)}</strong>

                  {/* delete button for each material */}
                  <button type="button" onClick={() => deleteMaterial(index)} 
                  className="delete-button">Delete</button>

                </li>
              ))}
            </ul>
          </div>
        )}
        

        {/* labor section */}
        <div className="labor-box">
            <h3>Labor</h3>
            {/* labor type dropdown */}
            <label>
                Labor Type:
                <select value={laborType} onChange={handleLaborTypeChange}>
                    <option value="">Select Labor Type</option>
                    <option value="apprentice">Apprentice</option>
                    <option value="regular">Regular</option>
                    <option value="projectManager">Project Manager</option>
                </select>
            </label>

            {/* editable labor rate */}
            {laborType && (
                <label>
                    Rate (${laborType.charAt(0).toUpperCase() + laborType.slice(1)}):
                    <input
                        type="number"
                        value={laborRate[laborType]}
                        onChange={handleLaborRateChange}
                        min="0"
                        step="0.01"
                    />
                </label>
            )}

            {/* labor quantity input */}
            <label>
                Quantity (hours):
                <input
                    type="number"
                    value={laborQuantity}
                    onChange={handleLaborQuantityChange}
                    min="1"
                />
            </label>

            {/* labor description input */}
            <label>
              Description:
              <input
                type="text"
                value={laborDescription}
                onChange={handleLaborDescriptionChange}
              />
            </label>
            
            {/* button to add labor to list  */}
            <button type="button" onClick={addLabor}>Add Labor</button>
        </div>

        {/* labor list section */}
        {laborList.length > 0 && (
            <div className="labor-list">
                <h3>Added Labor</h3>
                <ul>
                    {laborList.map((labor, index) => (
                        <li key={index}>
                            {labor.quantity} hours of <strong>{labor.type}</strong> @ ${labor.rate.toFixed(2)} per hour = <strong>${labor.total.toFixed(2)}</strong>

                            {/* delete Button for each labor */}
                            <button type="button" onClick={() => deleteLabor(index)} 
                            className="delete-button">Delete</button>
                        
                            {/* description for each entry */}
                            {labor.description && (
                              <div className="labor-description">
                                  â€¢ {labor.description}
                              </div>
                            )}                 
                        </li>
                    ))}
                </ul>
            </div>
        )}  
      
        {/* business Expenses Section */}
        <div className="business-expenses-box">
            <h3>Business Expenses</h3>
            <label>Material Markup Percentage (%):</label>
            <input type="number" value={materialMarkupPercentage} onChange={handleMaterialMarkupChange} min="0" max="100" step="0.1" />

            <label>Final Markup Percentage (%):</label>
            <input type="number" value={finalCostsPercentage} onChange={handleFinalCostsChange} min="0" max="100" step="0.1" />

            {/* show total costs before and after markup */}
            <div>
                <p><strong>Total Material Costs (Before Markup):</strong> ${materialList.reduce((acc, mat) => acc + mat.total, 0).toFixed(2)}</p>
                <p><strong>Total Material Costs (After Markup):</strong> ${materialList.reduce((acc, mat) => acc + mat.markupTotal, 0).toFixed(2)}</p>
                <p><strong>Total Labor Costs:</strong> ${laborList.reduce((acc, labor) => acc + labor.total, 0).toFixed(2)}</p>
                <p><strong>Total Estimate (After Final Markup):</strong> ${calculateTotalEstimate()}</p>
            </div>
          </div>
        
       {/* Generate Estimate Button */}
        <div className="generate-estimate">
          <button type="button" onClick={handleGenerateEstimate}>
            Generate Estimate
          </button>
        </div>

      {/* Show EstimateResult conditionally */}
        {estimateReady && (
          <EstimateResult
            customer={{ name: customerName, address: customerAddress, cityStateZip: customerCityStatePostalCode, phone: customerPhone, email: customerEmail }}
            materials={materialList}
            labor={laborList}
            materialMarkupPercentage={materialMarkupPercentage}
            finalCostsPercentage={finalCostsPercentage}
            total={calculateTotalEstimate()}
          />
      )}  
    </div>
    );
  };
  
  export default EstimateForm;
    